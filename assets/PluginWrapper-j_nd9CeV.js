import{u as D,r as p,R as o,a7 as R,a8 as k,P as n,I as _,a9 as v,aa as V,ab as W,ac as B,ad as Y,ae as F,af as O,ag as G,j as i,C as $,a as z,n as U}from"./index-UNAnFigi.js";import{u as q,L as K,f as H,C as Q,eS as X,eD as J,aw as L,eV as Z,ey as ee,be as ae,a2 as se,bN as te,aU as re,f2 as T,f0 as ne,eW as ie,eU as oe,eT as ce,ag as le}from"./index-BoZhGQm_.js";const f={READY:"READY",INSTALLING:"INSTALLING"};function A({installingWorker:e,onStateChange:a}){e.onstatechange=()=>{e.state==="activated"&&a(f.READY)}}async function pe({onStateChange:e}){if(!navigator.serviceWorker)return null;const a=await navigator.serviceWorker.getRegistration();return a?a.active?f.READY:a.installing?(A({installingWorker:a.installing,onStateChange:e}),f.INSTALLING):(a.onupdatefound=()=>{e(f.INSTALLING);const s=a.installing;s&&A({installingWorker:s,onStateChange:e})},null):null}const de=()=>o.createElement(K,null,o.createElement(H,null,o.createElement(Q,null))),S=({id:e,children:a,isParentCached:s=!1})=>{const{startRecording:t,isCached:r,remove:c}=R(e);return p.useEffect(()=>{const y=s&&!r,d=!s&&r;y&&t({onError:console.error}),d&&c()},[r,s,c,t]),o.createElement(k,{id:e,loadingMask:o.createElement(de,null)},a)};S.propTypes={children:n.node,id:n.string,isParentCached:n.bool};const w=({onInstallationStatusChange:e=Function.prototype,children:a,cacheId:s,isParentCached:t=!1,...r})=>{const{pwaEnabled:c}=D();return p.useEffect(()=>{pe({onStateChange:e}).then(e)},[e]),r?o.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},c?o.createElement(S,{id:s,isParentCached:t},a(r)):a(r),o.createElement(q,{colors:!0,spacers:!0,elevations:!0})):null};w.propTypes={cacheId:n.string,children:n.func,isParentCached:n.bool,onInstallationStatusChange:n.func};var ue=G,ye=F,fe=Y,me=V,ge=v,be=W,Ee=O,he=B,Le="[object Map]",Te="[object Set]",Ae=Object.prototype,Se=Ae.hasOwnProperty;function we(e){if(e==null)return!0;if(ge(e)&&(me(e)||typeof e=="string"||typeof e.splice=="function"||be(e)||he(e)||fe(e)))return!e.length;var a=ye(e);if(a==Le||a==Te)return!e.size;if(Ee(e))return!ue(e).length;for(var s in e)if(Se.call(e,s))return!1;return!0}var Pe=we;const xe=_(Pe),Ce=async({engine:e,basemapId:a,defaultBasemapId:s})=>{if(!(L(a)||L(s)))return[];try{const{externalLayers:t}=await e.query({externalLayers:Z});return t.externalMapLayers}catch(t){return console.warn("Failed to fetch external basemaps:",t),[]}},je=async({basemapId:e,basemapVisible:a,keyDefaultBaseMap:s,systemSettings:t,engine:r})=>{const c=await Ce({engine:r,basemapId:e,defaultBasemapId:s}),y=await X({externalMapLayers:c,systemSettings:t}),d=J({basemaps:y,id:e,defaultId:s,onMissing:m=>console.warn(m)});return typeof a=="boolean"&&(d.isVisible=a),{basemap:d}},Ie=(e,a,s)=>{const{name:t}=e;return ee({ao:e,engine:s}).then(r=>({name:t,basemap:{id:a},mapViews:[{id:ae(),...r}]}))},Me=()=>i.jsx("div",{style:{position:"absolute",width:"100%",height:"100%",top:0},children:i.jsx($,{children:i.jsx(z,{})})}),P=({visualization:e})=>{const a=U(),{systemSettings:s}=se(),[t,r]=p.useState(null);p.useEffect(()=>{const{basemap:C,mapViews:g,id:b,...j}=e,I=async()=>{var E,h;const{keyDefaultBaseMap:u}=s;let l;if(b&&!g){const N=await re({id:b,engine:a,defaultBasemap:u});l=T(N,u)}else g?l=T({basemap:C,mapViews:g},u):l=await Ie(j,u,a);const{basemap:M}=await je({basemapId:(E=l.basemap)==null?void 0:E.id,basemapVisible:(h=l.basemap)==null?void 0:h.isVisible,keyDefaultBaseMap:u,systemSettings:s,engine:a});r({...l,basemap:M})};xe(s)||I()},[e,s,a]);const{basemap:c,mapViews:y,id:d,...m}=e;return t?i.jsx(te,{...t,...m}):i.jsx(Me,{})};P.propTypes={visualization:n.object};const Ne={systemSettings:{resource:"systemSettings",params:{key:ie}},currentUser:{resource:"me",params:{fields:"id,username,displayName~rename(name),authorities,settings[keyAnalysisDisplayProperty]"}}},De=({systemSettings:e,currentUser:a})=>({systemSettings:Object.assign({},oe,e,{hiddenPeriods:ce(e)}),currentUser:{id:a.id,name:a.name,username:a.username,authorities:new Set(a.authorities),keyAnalysisDisplayProperty:a.settings.keyAnalysisDisplayProperty},nameProperty:a.settings.keyAnalysisDisplayProperty==="name"?"displayName":"displayShortName"}),x=({visualization:e,displayProperty:a})=>i.jsx(ne,{query:Ne,dataTransformation:De,translucent:!1,children:i.jsx(P,{visualization:e,displayProperty:a})});x.propTypes={displayProperty:n.string,visualization:n.object};const _e=e=>{const[a,s]=p.useState(null);return p.useLayoutEffect(()=>{const t=le.debounce(300,()=>s(r=>typeof r=="number"?r+1:1));return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]),i.jsx(w,{...e,children:t=>i.jsx(x,{id:a,...t})})};export{_e as default};
//# sourceMappingURL=PluginWrapper-j_nd9CeV.js.map
