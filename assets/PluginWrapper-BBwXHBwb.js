import{u as D,r as p,R as o,ab as _,ac as v,L as V,C as S,a as w,P as n,a3 as B,ad as W,ae as Y,af as F,ag as G,ah as O,ai as q,aj as z,ak as U,j as i,w as K}from"./index-C-fk_cxn.js";import{J as X,eT as $,eE as H,aG as T,eW as J,eB as Q,bo as Z,ac as ee,bU as ae,b2 as te,f2 as L,f1 as se,eX as re,eV as ne,eU as ie,aq as oe}from"./index-CQLuOOtN.js";const f={READY:"READY",INSTALLING:"INSTALLING"};function A({installingWorker:e,onStateChange:a}){e.onstatechange=()=>{e.state==="activated"&&a(f.READY)}}async function ce({onStateChange:e}){if(!navigator.serviceWorker)return null;const a=await navigator.serviceWorker.getRegistration();return a?a.active?f.READY:a.installing?(A({installingWorker:a.installing,onStateChange:e}),f.INSTALLING):(a.onupdatefound=()=>{e(f.INSTALLING);const t=a.installing;t&&A({installingWorker:t,onStateChange:e})},null):null}const le=()=>o.createElement(V,null,o.createElement(S,null,o.createElement(w,null))),P=({id:e,children:a,isParentCached:t=!1})=>{const{startRecording:s,isCached:r,remove:c}=_(e);return p.useEffect(()=>{const y=t&&!r,d=!t&&r;y&&s({onError:console.error}),d&&c()},[r,t,c,s]),o.createElement(v,{id:e,loadingMask:o.createElement(le,null)},a)};P.propTypes={children:n.node,id:n.string,isParentCached:n.bool};const x=({onInstallationStatusChange:e=Function.prototype,children:a,cacheId:t,isParentCached:s=!1,...r})=>{const{pwaEnabled:c}=D();return p.useEffect(()=>{ce({onStateChange:e}).then(e)},[e]),r?o.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},c?o.createElement(P,{id:t,isParentCached:s},a(r)):a(r),o.createElement(X,{colors:!0,spacers:!0,elevations:!0})):null};x.propTypes={cacheId:n.string,children:n.func,isParentCached:n.bool,onInstallationStatusChange:n.func};var pe=U,de=q,ue=O,ye=Y,fe=W,me=F,ge=z,be=G,Ee="[object Map]",he="[object Set]",Te=Object.prototype,Le=Te.hasOwnProperty;function Ae(e){if(e==null)return!0;if(fe(e)&&(ye(e)||typeof e=="string"||typeof e.splice=="function"||me(e)||be(e)||ue(e)))return!e.length;var a=de(e);if(a==Ee||a==he)return!e.size;if(ge(e))return!pe(e).length;for(var t in e)if(Le.call(e,t))return!1;return!0}var Se=Ae;const we=B(Se),Pe=async({engine:e,basemapId:a,defaultBasemapId:t})=>{if(!(T(a)||T(t)))return[];try{const{externalLayers:s}=await e.query({externalLayers:J});return s.externalMapLayers}catch(s){return console.warn("Failed to fetch external basemaps:",s),[]}},xe=async({basemapId:e,basemapVisible:a,keyDefaultBaseMap:t,systemSettings:s,engine:r})=>{const c=await Pe({engine:r,basemapId:e,defaultBasemapId:t}),y=await $({externalMapLayers:c,systemSettings:s}),d=H({basemaps:y,id:e,defaultId:t,onMissing:m=>console.warn(m)});return typeof a=="boolean"&&(d.isVisible=a),{basemap:d}},je=(e,a,t)=>{const{name:s}=e;return Q({ao:e,engine:t}).then(r=>({name:s,basemap:{id:a},mapViews:[{id:Z(),...r}]}))},Ce=()=>i.jsx("div",{style:{position:"absolute",width:"100%",height:"100%",top:0},children:i.jsx(S,{children:i.jsx(w,{})})}),j=({visualization:e})=>{const a=K(),{systemSettings:t}=ee(),[s,r]=p.useState(null);p.useEffect(()=>{const{basemap:I,mapViews:g,id:b,...M}=e,N=async()=>{var E,h;const{keyDefaultBaseMap:u}=t;let l;if(b&&!g){const R=await te({id:b,engine:a,defaultBasemap:u});l=L(R,u)}else g?l=L({basemap:I,mapViews:g},u):l=await je(M,u,a);const{basemap:k}=await xe({basemapId:(E=l.basemap)==null?void 0:E.id,basemapVisible:(h=l.basemap)==null?void 0:h.isVisible,keyDefaultBaseMap:u,systemSettings:t,engine:a});r({...l,basemap:k})};we(t)||N()},[e,t,a]);const{basemap:c,mapViews:y,id:d,...m}=e;return s?i.jsx(ae,{...s,...m}):i.jsx(Ce,{})};j.propTypes={visualization:n.object};const Ie={systemSettings:{resource:"systemSettings",params:{key:re}},currentUser:{resource:"me",params:{fields:"id,username,displayName~rename(name),authorities,settings[keyAnalysisDisplayProperty]"}}},Me=({systemSettings:e,currentUser:a})=>({systemSettings:Object.assign({},ne,e,{hiddenPeriods:ie(e)}),currentUser:{id:a.id,name:a.name,username:a.username,authorities:new Set(a.authorities),keyAnalysisDisplayProperty:a.settings.keyAnalysisDisplayProperty},nameProperty:a.settings.keyAnalysisDisplayProperty==="name"?"displayName":"displayShortName"}),C=({visualization:e,displayProperty:a})=>i.jsx(se,{query:Ie,dataTransformation:Me,translucent:!1,children:i.jsx(j,{visualization:e,displayProperty:a})});C.propTypes={displayProperty:n.string,visualization:n.object};const Re=e=>{const[a,t]=p.useState(null);return p.useLayoutEffect(()=>{const s=oe.debounce(300,()=>t(r=>typeof r=="number"?r+1:1));return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),i.jsx(x,{...e,children:s=>i.jsx(C,{id:a,...s})})};export{Re as default};
//# sourceMappingURL=PluginWrapper-BBwXHBwb.js.map
