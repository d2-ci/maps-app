import{u as D,r as p,R as o,ab as _,ac as v,L as V,C as S,a as w,P as n,a3 as B,ad as W,ae as Y,af as F,ag as G,ah as O,ai as z,aj as q,ak as U,j as i,w as $}from"./index-C-fk_cxn.js";import{J as K,eR as H,eC as J,aG as T,eU as Q,ez as X,bo as Z,ac as ee,bU as ae,b2 as te,f0 as L,e$ as se,eV as re,eT as ne,eS as ie,aq as oe}from"./index-BrigbSL7.js";const m={READY:"READY",INSTALLING:"INSTALLING"};function A({installingWorker:e,onStateChange:a}){e.onstatechange=()=>{e.state==="activated"&&a(m.READY)}}async function ce({onStateChange:e}){if(!navigator.serviceWorker)return null;const a=await navigator.serviceWorker.getRegistration();return a?a.active?m.READY:a.installing?(A({installingWorker:a.installing,onStateChange:e}),m.INSTALLING):(a.onupdatefound=()=>{e(m.INSTALLING);const t=a.installing;t&&A({installingWorker:t,onStateChange:e})},null):null}const le=()=>o.createElement(V,null,o.createElement(S,null,o.createElement(w,null))),P=({id:e,children:a,isParentCached:t=!1})=>{const{startRecording:s,isCached:r,remove:c}=_(e);return p.useEffect(()=>{const y=t&&!r,d=!t&&r;y&&s({onError:console.error}),d&&c()},[r,t,c,s]),o.createElement(v,{id:e,loadingMask:o.createElement(le,null)},a)};P.propTypes={children:n.node,id:n.string,isParentCached:n.bool};const x=({onInstallationStatusChange:e=Function.prototype,children:a,cacheId:t,isParentCached:s=!1,...r})=>{const{pwaEnabled:c}=D();return p.useEffect(()=>{ce({onStateChange:e}).then(e)},[e]),r?o.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},c?o.createElement(P,{id:t,isParentCached:s},a(r)):a(r),o.createElement(K,{colors:!0,spacers:!0,elevations:!0})):null};x.propTypes={cacheId:n.string,children:n.func,isParentCached:n.bool,onInstallationStatusChange:n.func};var pe=U,de=z,ue=O,ye=Y,me=W,fe=F,ge=q,be=G,he="[object Map]",Ee="[object Set]",Te=Object.prototype,Le=Te.hasOwnProperty;function Ae(e){if(e==null)return!0;if(me(e)&&(ye(e)||typeof e=="string"||typeof e.splice=="function"||fe(e)||be(e)||ue(e)))return!e.length;var a=de(e);if(a==he||a==Ee)return!e.size;if(ge(e))return!pe(e).length;for(var t in e)if(Le.call(e,t))return!1;return!0}var Se=Ae;const we=B(Se),Pe=async({engine:e,basemapId:a,defaultBasemapId:t})=>{if(!(T(a)||T(t)))return[];try{const{externalLayers:s}=await e.query({externalLayers:Q});return s.externalMapLayers}catch(s){return console.warn("Failed to fetch external basemaps:",s),[]}},xe=async({basemapId:e,basemapVisible:a,keyDefaultBaseMap:t,systemSettings:s,engine:r})=>{const c=await Pe({engine:r,basemapId:e,defaultBasemapId:t}),y=await H({externalMapLayers:c,systemSettings:s}),d=J({basemaps:y,id:e,defaultId:t,onMissing:f=>console.warn(f)});return typeof a=="boolean"&&(d.isVisible=a),{basemap:d}},je=(e,a,t)=>{const{name:s}=e;return X({ao:e,engine:t}).then(r=>({name:s,basemap:{id:a},mapViews:[{id:Z(),...r}]}))},Ce=()=>i.jsx("div",{style:{position:"absolute",width:"100%",height:"100%",top:0},children:i.jsx(S,{children:i.jsx(w,{})})}),j=({visualization:e})=>{const a=$(),{systemSettings:t}=ee(),[s,r]=p.useState(null);p.useEffect(()=>{const{basemap:I,mapViews:g,id:b,...M}=e,N=async()=>{var h,E;const{keyDefaultBaseMap:u}=t;let l;if(b&&!g){const k=await te({id:b,engine:a,defaultBasemap:u});l=L(k,u)}else g?l=L({basemap:I,mapViews:g},u):l=await je(M,u,a);const{basemap:R}=await xe({basemapId:(h=l.basemap)==null?void 0:h.id,basemapVisible:(E=l.basemap)==null?void 0:E.isVisible,keyDefaultBaseMap:u,systemSettings:t,engine:a});r({...l,basemap:R})};we(t)||N()},[e,t,a]);const{basemap:c,mapViews:y,id:d,...f}=e;return s?i.jsx(ae,{...s,...f}):i.jsx(Ce,{})};j.propTypes={visualization:n.object};const Ie={systemSettings:{resource:"systemSettings",params:{key:re}},currentUser:{resource:"me",params:{fields:"id,username,displayName~rename(name),authorities,settings[keyAnalysisDisplayProperty]"}}},Me=({systemSettings:e,currentUser:a})=>({systemSettings:Object.assign({},ne,e,{hiddenPeriods:ie(e)}),currentUser:{id:a.id,name:a.name,username:a.username,authorities:new Set(a.authorities),keyAnalysisDisplayProperty:a.settings.keyAnalysisDisplayProperty},nameProperty:a.settings.keyAnalysisDisplayProperty==="name"?"displayName":"displayShortName"}),C=({visualization:e,displayProperty:a})=>i.jsx(se,{query:Ie,dataTransformation:Me,translucent:!1,children:i.jsx(j,{visualization:e,displayProperty:a})});C.propTypes={displayProperty:n.string,visualization:n.object};const ke=e=>{const[a,t]=p.useState(null);return p.useLayoutEffect(()=>{const s=oe.debounce(300,()=>t(r=>typeof r=="number"?r+1:1));return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),i.jsx(x,{...e,children:s=>i.jsx(C,{id:a,...s})})};export{ke as default};
//# sourceMappingURL=PluginWrapper-DZT4oVdU.js.map
