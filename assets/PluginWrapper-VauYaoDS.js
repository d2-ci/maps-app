import{u as D,r as l,R as o,aa as _,ab as v,L as V,C as S,a as w,P as n,a2 as W,ac as B,ad as O,ae as Y,af as F,ag as G,ah as z,ai as X,aj as q,j as i,p as K}from"./index-wrE11d-R.js";import{v as U,eT as $,eE as H,az as T,eW as Q,ez as J,bh as Z,a5 as ee,bO as ae,aX as te,f2 as L,f1 as se,eX as re,eV as ne,eU as ie,aj as oe}from"./index-CxQ3UlA_.js";const f={READY:"READY",INSTALLING:"INSTALLING"};function A({installingWorker:e,onStateChange:a}){e.onstatechange=()=>{e.state==="activated"&&a(f.READY)}}async function ce({onStateChange:e}){if(!navigator.serviceWorker)return null;const a=await navigator.serviceWorker.getRegistration();return a?a.active?f.READY:a.installing?(A({installingWorker:a.installing,onStateChange:e}),f.INSTALLING):(a.onupdatefound=()=>{e(f.INSTALLING);const t=a.installing;t&&A({installingWorker:t,onStateChange:e})},null):null}const pe=()=>o.createElement(V,null,o.createElement(S,null,o.createElement(w,null))),P=({id:e,children:a,isParentCached:t=!1})=>{const{startRecording:s,isCached:r,remove:c}=_(e);return l.useEffect(()=>{const y=t&&!r,d=!t&&r;y&&s({onError:console.error}),d&&c()},[r,t,c,s]),o.createElement(v,{id:e,loadingMask:o.createElement(pe,null)},a)};P.propTypes={children:n.node,id:n.string,isParentCached:n.bool};const j=({onInstallationStatusChange:e=Function.prototype,children:a,cacheId:t,isParentCached:s=!1,...r})=>{const{pwaEnabled:c}=D();return l.useEffect(()=>{ce({onStateChange:e}).then(e)},[e]),r?o.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},c?o.createElement(P,{id:t,isParentCached:s},a(r)):a(r),o.createElement(U,{colors:!0,spacers:!0,elevations:!0})):null};j.propTypes={cacheId:n.string,children:n.func,isParentCached:n.bool,onInstallationStatusChange:n.func};var le=q,de=z,ue=G,ye=O,fe=B,me=Y,ge=X,be=F,he="[object Map]",Ee="[object Set]",Te=Object.prototype,Le=Te.hasOwnProperty;function Ae(e){if(e==null)return!0;if(fe(e)&&(ye(e)||typeof e=="string"||typeof e.splice=="function"||me(e)||be(e)||ue(e)))return!e.length;var a=de(e);if(a==he||a==Ee)return!e.size;if(ge(e))return!le(e).length;for(var t in e)if(Le.call(e,t))return!1;return!0}var Se=Ae;const we=W(Se),Pe=async({engine:e,basemapId:a,defaultBasemapId:t})=>{if(!(T(a)||T(t)))return[];try{const{externalLayers:s}=await e.query({externalLayers:Q});return s.externalMapLayers}catch(s){return console.warn("Failed to fetch external basemaps:",s),[]}},je=async({basemapId:e,basemapVisible:a,keyDefaultBaseMap:t,systemSettings:s,engine:r})=>{const c=await Pe({engine:r,basemapId:e,defaultBasemapId:t}),y=await $({externalMapLayers:c,systemSettings:s}),d=H({basemaps:y,id:e,defaultId:t,onMissing:m=>console.warn(m)});return typeof a=="boolean"&&(d.isVisible=a),{basemap:d}},xe=(e,a,t)=>{const{name:s}=e;return J({ao:e,engine:t}).then(r=>({name:s,basemap:{id:a},mapViews:[{id:Z(),...r}]}))},Ce=()=>i.jsx("div",{style:{position:"absolute",width:"100%",height:"100%",top:0},children:i.jsx(S,{children:i.jsx(w,{})})}),x=({visualization:e})=>{const a=K(),{systemSettings:t}=ee(),[s,r]=l.useState(null);l.useEffect(()=>{const{basemap:I,mapViews:g,id:b,...M}=e,N=async()=>{var h,E;const{keyDefaultBaseMap:u}=t;let p;if(b&&!g){const k=await te({id:b,engine:a,defaultBasemap:u});p=L(k,u)}else g?p=L({basemap:I,mapViews:g},u):p=await xe(M,u,a);const{basemap:R}=await je({basemapId:(h=p.basemap)==null?void 0:h.id,basemapVisible:(E=p.basemap)==null?void 0:E.isVisible,keyDefaultBaseMap:u,systemSettings:t,engine:a});r({...p,basemap:R})};we(t)||N()},[e,t,a]);const{basemap:c,mapViews:y,id:d,...m}=e;return s?i.jsx(ae,{...s,...m}):i.jsx(Ce,{})};x.propTypes={visualization:n.object};const Ie={systemSettings:{resource:"systemSettings",params:{key:re}},currentUser:{resource:"me",params:{fields:"id,username,displayName~rename(name),authorities,settings[keyAnalysisDisplayProperty]"}}},Me=({systemSettings:e,currentUser:a})=>({systemSettings:Object.assign({},ne,e,{hiddenPeriods:ie(e)}),currentUser:{id:a.id,name:a.name,username:a.username,authorities:new Set(a.authorities),keyAnalysisDisplayProperty:a.settings.keyAnalysisDisplayProperty},nameProperty:a.settings.keyAnalysisDisplayProperty==="name"?"displayName":"displayShortName"}),C=({visualization:e,displayProperty:a})=>i.jsx(se,{query:Ie,dataTransformation:Me,translucent:!1,children:i.jsx(x,{visualization:e,displayProperty:a})});C.propTypes={displayProperty:n.string,visualization:n.object};const ke=e=>{const[a,t]=l.useState(null);return l.useLayoutEffect(()=>{const s=oe.debounce(300,()=>t(r=>typeof r=="number"?r+1:1));return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[]),i.jsx(j,{...e,children:s=>i.jsx(C,{id:a,...s})})};export{ke as default};
//# sourceMappingURL=PluginWrapper-VauYaoDS.js.map
